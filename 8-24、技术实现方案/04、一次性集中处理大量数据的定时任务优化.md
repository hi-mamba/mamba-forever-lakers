
[原文](https://cloud.tencent.com/developer/article/1488894)

# 一次性集中处理大量数据的定时任务优化

## 问题抽象：

（1）用户会员系统；

（2）用户会有分数流水，每个月要做一次分数统计，对不同分数等级的会员做不同业务处理


数据假设：


（1）假设用户在100w级别；

（2）假设用户日均1条流水，也就是说日增流水数据量在100W级别，月新增流水在3kW级别，3个月流水数据量在亿级别；


## 常见解决方案：

用一个定时任务，每个月的第一天计算一次。


### 一个月执行一次的定时任务，会存在什么问题？

计算量很大，处理的数据量很大，耗时很久，按照水友的说法，需要1-2天。

画外音：外层循环100W级别用户；内层循环9kW级别流水；业务处理需要10几次数据库交互。

### 可不可以多线程并行处理？

可以，每个用户的流水处理不耦合。

改为多线程并行处理，例如按照用户拆分，会存在什么问题？

每个线程都要访问数据库做业务处理，数据库有可能扛不住。


### 这类问题的优化方向是：

（1）同一份数据，减少重复计算次数；

（2）分摊CPU计算时间，尽量分散处理，而不是集中处理；

（3）减少单次计算数据量；


## 最终解决方案

canal 增加一个分数流水表的监听，当用户的分数变化时，实时进行日分数流水累加，
将1小时一次的定时任务计算，均匀分摊到“每时每刻”，每天新增100w流水，数据库写压力每秒钟10多次，完全扛得住。

画外音：如果不能使用DTS/canal，可以使用MQ。


## 总结，

对于这类一次性集中处理大量数据的定时任务，优化思路是：

（1）同一份数据，减少重复计算次数；

（2）分摊CPU计算时间，尽量分散处理（甚至可以实时），而不是集中处理；

（3）减少单次计算数据量；


